const E={TW:{siteName:"台湾",host:"xiapi.xiapibuy.com"},MALAYSIA:{siteName:"马来西亚",host:"my.xiapibuy.com"},SINGAPORE:{siteName:"新加坡",host:"sg.xiapibuy.com"},PH:{siteName:"菲律宾",host:"ph.xiapibuy.com"},VN:{siteName:"越南",host:"vn.xiapibuy.com"},TH:{siteName:"泰国",host:"th.xiapibuy.com"}},g=`zhixia_${y()}`,m=`shopee_${y()}`;function S(t){const e=Object.values(E).find(o=>t===o.host);return e?e.siteName:"未知"}function A({itemId:t,shopId:e,itemName:o}){if(!(!t||!e||!o))return`https://${location.href}/${o}-i.${e}.${t}`}chrome.runtime.onMessage.addListener((t,e,o)=>{if(t.type==="FROM_POPUP"){let c=0,a=0;if(t.payload.action==="download_csv"){const n=localStorage.getItem(g)||"[]",l=localStorage.getItem(m)||"[]",p=JSON.parse(n)||[],d=JSON.parse(l)||[];if(p.length>0||d.length>0){const h=b(p,d),_=new Blob(["\uFEFF"+h],{type:"text/csv;charset=utf-8;"}),r=document.createElement("a");if(r.download!==void 0){const i=URL.createObjectURL(_);r.setAttribute("href",i),r.setAttribute("download",`${m}.csv`),r.style.visibility="hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r)}}}if(t.payload.action==="clear"&&(localStorage.removeItem(g),localStorage.removeItem(m),c=0,a=0),t.payload.action==="get_count"){const n=localStorage.getItem(g);n?c=(JSON.parse(n)||[]).length:c=0;const l=localStorage.getItem(m);l?a=(JSON.parse(l)||[]).length:a=0}o({type:"FROM_CONTENT",payload:{zhixiaDataLength:c,shopeeDataLength:a}})}return!0});window.addEventListener("message",function(t){try{const e=JSON.parse(t.data);e.code==="REQUEST_CODE"&&e.data&&e.data.request&&e.data.request.length&&O(e.data.request[0],e)}catch{console.error("Error parsing message data:",t.data)}},!1);function b(t,e){var h,_;const o=((h=document.querySelector(".shopee-category-list .shopee-category-list__main-category__link"))==null?void 0:h.innerText)||"",c=((_=document.querySelector(".shopee-category-list .shopee-category-list__sub-category--active"))==null?void 0:_.innerText)||"",a=e.reduce((r,i)=>(r[i.itemid]={shopeeSold:i.sold,shopeeHistoricalSold:i.historical_sold,shopeeLocation:i.shop_location,itemName:i.itemName,realPrice:i.price,createTime:i.ctime,product_url:i.product_url},r),{}),n=t.map(r=>({...r,...a[r.itemId]})),l=[["imgUrl","图片"],["itemId","商品ID"],["itemName","商品名称"],["catName","类目路径"],["createTime","上架时间"],["sold","总销量"],["sales","近1天销量"],["sales7Day","近7天销量"],["sales30Day","近30天销量"],["gmv30Day","近30天销售额"],["sales30Rate","近30天销量增长率"],["realPrice","实际价格(shopee)"],["shopeeSold","最近30天销量(shopee)"],["shopeeHistoricalSold","历史销量(shopee)"],["shopeeLocation","店铺位置(shopee)"],["tranPrice","价格走势"],["likeCount","点赞数"],["ratingNum","评论数"],["ratingStar","商品评分"],["product_url","商品链接"],["firstCategory","一级类目"],["secondCategory","二级类目"],["siteName","站点"]],p=l.map(r=>r[1]),d=n.map(r=>l.map(([i])=>{var u;switch(i){case"tranPrice":return((u=r[i])==null?void 0:u.replace(/[￥~]/g,""))||"";case"sales30Rate":return`${r[i]}%`;case"firstCategory":return o;case"secondCategory":return c;case"siteName":return S(location.host);default:return r[i]??""}}).map(i=>`"${String(i).replace(/"/g,'""')}"`).join(","));return[p.join(","),...d].join(`
`)}function y(t=Date.now()){return new Date(t).toLocaleDateString("zh-CN",{timeZone:"Asia/Shanghai",year:"numeric",month:"2-digit",day:"2-digit"}).replace(/\//g,"-")}function O(t,e){var c=[{rule:/^.*\/api\/v[0-9].*?\/search\/search_items/,handler:s},{rule:/^.*\/api\/v[0-9].*?\/search_items(\/)?\?by=pop.*?page_type=shop.*?/,handler:s},{rule:/^.*\/api\/v[0-9].*?\/search_items(\/)?\?by=relevancy.*?page_type=search.*?&scenario=.*?/,handler:s},{rule:/^.*\/api\/v[0-9].*?\/search_items(\/)?\?by=ctime.*?page_type=.*?&scenario=PAGE_GLOBAL_SEARCH.*/,handler:s},{rule:/^.*\/api\/v[0-9].*?\/search_items(\/)?\?by=ctime.*?page_type=.*?&scenario=PAGE_OTHERS.*/,handler:s},{rule:/^.*\/api\/v[0-9].*?\/search_items(\/)?\?by=sales.*&limit=30|60.*?page_type=.*?&scenario=PAGE_GLOBAL_SEARCH.*/,handler:s},{rule:/^.*\/api\/v[0-9].*?\/search_items(\/)?\?by=sales.*&limit=30|60.*?page_type=.*?&scenario=PAGE_OTHERS.*/,handler:s},{rule:/^.*\/api\/v[0-9].*?\/search_items(\/)?\?by=price.*?page_type=.*?&scenario=.*/,handler:s},{rule:/^.*\/api\/v[0-9].*?\/search_items(\/)?\?by=pop.*?page_type=search.*?&scenario=PAGE_GLOBAL_SEARCH.*/,handler:s},{rule:/^.*\/api\/v[0-9].*?\/search_items(\/)?\?by=pop.*?page_type=search.*?&scenario=PAGE_CATEGORY.*?/,handler:s},{rule:/^.*\/api\/v[0-9].*?\/search_items(\/)?\?by=ctime.*?page_type=search.*?&scenario=PAGE_CATEGORY.*?/,handler:s},{rule:/^.*\/api\/v[0-9].*?\/search_items(\/)?\?by=sales.*?page_type=search.*?&scenario=PAGE_CATEGORY.*?/,handler:s},{rule:/^.*\/api\/v[0-9].*?\/search_items(\/)?\?by=pop.*?page_type=collection.*?&scenario=PAGE_COLLECTION.*/,handler:s},{rule:/^.*\/api\/v[0-9].*?\/search_items(\/)?\?by=ctime.*?page_type=collection.*?&scenario=PAGE_COLLECTION.*/,handler:s},{rule:/^.*\/api\/v[0-9].*?\/search_items(\/)?\?by=sales.*?page_type=collection.*?&scenario=PAGE_COLLECTION.*/,handler:s},{rule:/^.*\/api\/v[0-9].*?\/search_items(\/)?\?by=price.*?page_type=collection.*?&scenario=PAGE_COLLECTION.*/,handler:s},{rule:/^.*\/api\/v[0-9].*?\/search_items(\/)?\?by=relevancy.*?page_type=collection.*?&scenario=PAGE_COLLECTION.*/,handler:s},{rule:/^.*\/api\/v[0-9].*?\/search_items(\/)?\?by=relevancy.*?page_type=search.*?&scenario=PAGE_CATEGORY.*/,handler:s},{rule:/^.*\/api\/v[0-9].*?\/search_items(\/)?\?by=price.*?page_type=search.*?&scenario=PAGE_CATEGORY.*/,handler:s},{rule:/^.*\/api\/v[0-9].*?\/search_items(\/)?\?by=pop.*?page_type=collection.*?&scenario=PAGE_GLOBAL_SEARCH.*/,handler:s},{rule:/^.*\/api\/v[0-9].*?\/search_items(\/)?\?by=relevancy.*?page_type=collection.*?&scenario=PAGE_GLOBAL_SEARCH.*/,handler:s},{rule:/^.*\/api\/v[0-9].*?\/recommend\/recommend_v2/,handler:f}].filter(function(a){return a.rule.test(t)});try{c[0].handler(e)}catch(a){a.toString()}}function s(t){const e=t.data.items;if(e.length==0)return;const o=e.map(c=>{const{item_basic:a,item_data:n,item_card_displayed_asset:l}=c;if(a){const{sold:p,historical_sold:d,shop_location:h,itemid:_,price:r,ctime:i,name:u}=a;return{sold:p,historical_sold:d,shop_location:h,itemid:_,price:r/1e5,itemName:u,ctime:y(i*1e3)}}if(n){const{itemid:p,item_card_display_price:d,ctime:h}=n;return{sold:"-",historical_sold:"-",shop_location:l.shop_location,itemid:p,price:d.price/1e5,itemName:l.name,ctime:y(h*1e3)}}});v(o)}function f(t){const e=t.data.data.units;if(e.length==0)return;const o=e.map(({item:c})=>{const{item_data:a,item_card_displayed_asset:n}=c,l=a.item_card_display_sold_count.monthly_sold_count,p=a.item_card_display_sold_count.historical_sold_count,d=a.shop_data.shop_location,h=a.item_card_display_price.item_id,_=a.item_card_display_price.price,r=A({itemId:h,shopId:a==null?void 0:a.shopid,itemName:n==null?void 0:n.name});return{sold:l,historical_sold:p,shop_location:d,itemid:h,price:_,product_url:r}});v(o)}function v(t){const e=localStorage.getItem(m);let o=[];e&&(o=JSON.parse(e)||[]),o=[...o,...t];const c=new Map(o.map(a=>[a.itemid,a]));o=Array.from(c.values()),localStorage.setItem(m,JSON.stringify(o)),chrome.runtime.sendMessage({type:"STORAGE_UPDATE",payload:{key:"shopeeDataLength",value:o.length}})}
